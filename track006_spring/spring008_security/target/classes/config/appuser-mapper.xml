<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thejoa703.dao.AppUserDao">
	
	
	<resultMap type="AppUserDto" id="AppUserMap">
		<result property="appUserId"  column="APP_USER_ID"/>
		<result property="email"  column="EMAIL"/>
		<result property="password"  column="PASSWORD"/>
		<result property="mbtiTypeId"  column="MBTI_TYPE_ID"/>
		<result property="createdAt"  column="CREATED_AT"/>
		<result property="ufile"  column="UFILE"/>
	</resultMap>
	
	<insert id="insert" parameterType="AppUserDto">
		insert into appuser(app_user_id, email, password, mbti_type_id, created_at) 
	                    values( appuser_seq.nextval, #{email}, #{password}, #{mbtiTypeId}, sysdate)
	</insert>
	
	<select  resultMap="AppUserMap" id="selectAll" >
		select * from appuser order by app_user_id desc
	</select>
	
	<select resultMap="AppUserMap"	id="select" parameterType="int">
		select * from appuser where app_user_id=#{appUserId}
	</select>
	
	<select resultMap="AppUserMap"	id="selectEmail" parameterType="String">
		select * from appuser where email=#{email} 
	</select>
	
	<select resultMap="AppUserMap"	id="selectLogin" parameterType="AppUserDto">
		select * from appuser where email=#{email} and password=#{password}
	</select>
	
	<update id="update" parameterType="AppUserDto">
		update appuser set password=#{password}, mbti_type_id=#{mbtiTypeId} 
			where app_user_id=#{appUserId} and password=#{password}
	</update>
	
	<delete id="delete" parameterType="AppUserDto">
		delete from appuser where app_user_id=#{appUserId} and password=#{password}
	</delete>
	
	
	
	<!--이미지 추가 버전-->
	
	<insert id="insertWithImg" parameterType="AppUserDto">
		insert into appuser(app_user_id, email, password, mbti_type_id, created_at, ufile) 
	                    values( appuser_seq.nextval, #{email}, #{password}, #{mbtiTypeId}, sysdate, #{ufile, jdbcType=VARCHAR})
	</insert>
	
	<update id="updateWithImg" parameterType="AppUserDto">
		update appuser set password=#{password}, mbti_type_id=#{mbtiTypeId}, ufile=#{ufile}
			where app_user_id=#{appUserId} and password=#{password}
	</update>
	
	
	<!-- 아이디 중복검사 -->
	<select resultType="int"  id="iddouble" parameterType="String">
		select count(*) as cnt from appuser where email=#{email}
	</select>
	
	<!-- 관리자 -->
	<delete id="deleteAdmin" parameterType="int">
		delete from appuser where app_user_id =#{appUserId}
	</delete>
	
	<update id="updateAdmin" parameterType="AppUserDto">
		update appuser set mbti_type_id=#{mbtiTypeId}
			where app_user_id=#{appUserId} 
	</update>
	
	
	
	
	<!-- SECURITY -->
	<resultMap type="AuthDto" id="authMap">
		<result property="email" column="EMAIL"/>
		<result property="auth" column="AUTH"/>
	</resultMap>
	
	<resultMap type="appUserAuthDto" id="appUserAuthMap">
		<result property="email" column="EMAIL"/>
		<result property="password" column="PASSWORD"/>
		<collection property="authList" resultMap="authMap"></collection>
	</resultMap>
		
	<select resultMap="appUserAuthMap" id="readAuth" parameterType="AppUserAuthDto">
		select a.email, password, auth
	    from appuser a left join authorities au on(a.email=au.email)
	    where a.email=#{email}
	</select>	

	<insert id="insertAuth" parameterType="AuthDto">
		insert into authorities(email, auth) values (#{email}, #{auth})
	</insert>
	
	
	</mapper>